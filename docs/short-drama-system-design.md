# 灵影短剧系统 - 详细开发规划

> 本文档整合了灵影短剧系统与Huobao Drama的设计优势，形成最优解决方案

---

## 一、项目概述

**系统定位**：AI作为专业短剧编剧+导演，基于MiniMax AI能力，将小说自动改编为抖音竖屏短剧素材

**核心目标**：
- 极致自动化：用户只提供小说内容，AI完成所有工作
- 质量可控：分集规划和剧本可审核，保证合格线以上质量
- 高效产出：追求速度，快速迭代
- 剧情100%还原：确保每个分镜完整覆盖剧本内容

---

## 二、设计方案对比与融合

### 2.1 系统设计对比

| 维度 | 灵影短剧系统（我们） | Huobao Drama | 融合方案 |
|------|---------------------|--------------|----------|
| 工作流程 | 20步细化的端到端流程 | 7阶段核心流程 | 采用7阶段模型，内部细化20步 |
| 镜头时长 | 30-60秒/镜头 | 4-12秒/镜头 | 采用4-12秒，更精细控制 |
| 分镜要素 | 基础要素集 | 完整详细要素（15+字段） | 采纳完整要素设计 |
| 剧情处理 | 极致压缩（去30%内容） | 100%完整还原 | 100%还原，确保不遗漏 |
| Prompt | 统一生成 | image/video分离 | 采用分离策略 |
| 任务管理 | 基础重试机制 | 完整异步任务系统 | 采纳异步任务管理 |
| 审核节点 | 分集规划+剧本审核 | 项目级审核 | 保持双审核节点 |

### 2.2 核心设计理念融合

**采用Huobao的设计理念：**
1. 剧情100%还原：分镜必须完整覆盖剧本每个字，不得省略
2. 时长精确控制：每镜4-12秒，根据对话+动作+复杂度综合计算
3. 专用Prompt分离：imagePrompt用于静态图，videoPrompt用于视频（含运镜）
4. 异步任务管理：长时间操作异步处理，支持失败重试和状态追踪
5. ID绑定机制：角色和场景使用数据库ID关联

**保持灵影的独特优势：**
1. 风格系统：ancient/modern/scifi/wuxia/default多风格支持
2. 爽点密度：每10秒一个爽点
3. 开篇3秒钩子，结尾悬念钩子
4. 说书人旁白+角色对话双轨制
5. 简洁的用户交互流程

---

## 三、系统配置参数

```
+------------------+----------------------+-------------------------------------+
| 配置项           | 推荐标准              | 说明                                |
+------------------+----------------------+-------------------------------------+
| 单集时长         | 3-5分钟              | 180-300秒                           |
| 分镜头数         | 15-30个镜头          | 根据剧本内容拆分，每个动作一个镜     |
| 镜头时长         | 4-12秒/镜头          | 精确计算：基础+对话+动作调整        |
| 爽点密度         | 每10秒一个爽点        | 情绪反转/打脸/揭晓/升级             |
| 视频比例         | 9:16竖屏             | 适配抖音/快手                       |
| 视频分辨率       | 1080x1920            | MiniMax标准                         |
| 角色数量         | 1-2个主角+反派       | 根据剧本提取                        |
| 钩子时效         | 3秒内抛出核心冲突     | 开篇必须                            |
| 悬念设置         | 每集结尾必设钩子      | cliffhanger                         |
| 剧情还原度       | 100%                 | 每个分镜对应剧本具体内容             |
+------------------+----------------------+-------------------------------------+
```

### 3.1 镜头时长计算规则

```
【时长估算公式】
最终时长 = 基础时长 + 对话调整 + 动作调整

【基础时长】
- 纯对话场景（无明显动作）：基础4秒
- 纯动作场景（无对话）：基础5秒
- 对话+动作混合场景：基础6秒

【对话调整】
- 无对话：+0秒
- 短对话（1-20字）：+1-2秒
- 中等对话（21-50字）：+2-4秒
- 长对话（51字以上）：+4-6秒

【动作调整】
- 无动作/静态：+0秒
- 简单动作（表情、转身、拿物品）：+0-1秒
- 一般动作（走动、开门、坐下）：+1-2秒
- 复杂动作（打斗、追逐、大幅度移动）：+2-4秒
- 环境展示（全景扫描、氛围营造）：+2-5秒

【时长范围限制】
- 所有镜头时长必须在4-12秒范围内
```

---

## 四、完整工作流程设计

### 4.1 核心工作流（7阶段20步）

```
阶段一：【准备阶段】
1. 用户输入：提供小说文件（支持txt/md/pdf）
   ↓
2. 章节分析：识别章节结构，评估剧情密度
   ↓
3. 分集规划：根据分析结果，规划每集内容
   ↓
用户审核①：确认/调整分集规划

阶段二：【大纲生成】
4. 剧情梗概：生成30章浓缩为300-500字梗概
   ↓
5. 核心元素：提取人设/世界观/核心冲突
   ↓
6. 故事线拆解：识别主线/支线/伏笔
   ↓
7. 卡点识别：标记高潮/反转/爽点/悬念
   ↓
用户审核②：确认/调整大纲内容

阶段三：【剧本生成】
8. 细纲生成：将故事线展开为详细细纲
   ↓
9. 集纲生成：每3-5章规划为一集，设计集末钩子
   ↓
10. 正文生成：基于集纲生成短剧正文剧本
   ↓
11. 剧本优化：去除小说化语言，强化对话冲突
   ↓
用户审核③：逐集审核剧本内容

阶段四：【分镜设计】
12. 分镜拆解：按"独立动作单元"拆分为分镜头
   ↓
13. 运镜规划：为每个镜头设计运镜方式
   ↓
14. 视觉Prompt：生成专用图像Prompt
   ↓
15. 视频Prompt：生成专用视频Prompt（含运镜指令）
   ↓
用户审核④：审核分镜设计方案

阶段五：【素材生成】
16. 角色生成：生成角色图片（保持一致性）
   ↓
17. 场景生成：生成场景图片
   ↓
18. 音频生成：生成旁白+对话配音+BGM+音效
   ↓
19. 视频生成：图生视频，生成每个镜头片段
   ↓
阶段六：【后期处理】
20. 素材整理：按镜头组织所有素材
   ↓
21. 视频合成：FFmpeg合并所有片段（可选）
   ↓
输出：可直接剪辑的素材包
```

### 4.2 工作流程图示

```
用户操作节点（◇）
AI自动处理（○）
用户审核节点（□）

◇ 提供小说文件
    ↓
○ 章节分析 + 分集规划
    ↓
◇ 审核分集规划
    ↓
○ 生成剧情梗概 + 核心元素
    ↓
◇ 审核大纲内容
    ↓
○ 细纲 + 集纲 + 正文剧本
    ↓
◇ 审核剧本内容
    ↓
○ 分镜拆解 + Prompt生成
    ↓
◇ 审核分镜设计
    ↓
○ 角色图 + 场景图 + 音频
    ↓
○ 视频生成
    ↓
○ 素材整理 + 视频合成
    ↓
◇ 下载素材包
```

---

## 五、分镜要素设计

### 5.1 完整分镜数据结构

每个分镜必须包含以下字段：

```
{
  "shot_number": 1,              // 镜头编号
  "title": "镜头标题",            // 3-5个字概括核心内容
  "shot_type": "全景/中景/近景/特写",  // 景别
  "angle": "平视/仰视/俯视/侧面/背面",  // 镜头角度
  "time": "时间+光线描述",         // 例如："深夜22:30·月光从破窗斜射入室内"
  "location": "地点+场景描述",      // 例如："废弃码头仓库·锈蚀货架林立"
  "scene_id": 1,                  // 背景场景ID
  "movement": "固定/推镜/拉镜/摇镜/跟镜/移镜",  // 运镜方式
  "action": "动作描述",           // 详细动作，包含肢体细节和表情
  "dialogue": "对话内容",         // 角色名："台词"，无对话则空字符串
  "result": "画面结果",           // 动作即时后果，视觉细节
  "atmosphere": "环境氛围",       // 光线+色调+声音环境
  "emotion": "情绪标注",          // 例如："好奇感↑↑转失望↓"
  "duration": 9,                  // 时长（秒），4-12秒范围
  "bgm_prompt": "BGM描述",        // 配乐氛围提示
  "sound_effect": "音效描述",      // 关键音效
  "characters": [159, 160],       // 涉及的角色ID数组
  "is_primary": true              // 是否主镜
}
```

### 5.2 字段详细说明

| 字段 | 要求 | 示例 |
|------|------|------|
| time | >=15字，包含时间+光线 | "深夜22:30·月光从破窗斜射入仓库，在地面积水中形成银白色反光" |
| location | >=20字，完整场景描述 | "废弃码头仓库·锈蚀货架林立，地面积水反射微弱灯光，墙角堆放腐朽木箱" |
| action | >=25字，肢体细节+表情 | "陈峥弯腰双手握住撬棍用力撬动保险箱门，手臂青筋暴起，眉头紧锁，汗水滑落" |
| result | >=25字，视觉结果细节 | "保险箱门突然弹开发出刺耳金属声，扬起灰尘，箱内空无一物，陈峥表情从期待转为失望" |
| atmosphere | >=20字，光线+色调+声音 | "昏暗冷色调·青灰色为主，只有手电筒光束晃动，远处传来海浪拍打声" |

### 5.3 运镜方式映射

| 场景类型 | 推荐运镜 | 说明 |
|----------|----------|------|
| 对话场景 | 固定镜头 | 保持稳定，便于观看对话 |
| 情绪增强 | 推进镜头 | 聚焦角色表情 |
| 场景转换 | 拉远镜头 | 展示环境全貌 |
| 动作场景 | 跟镜头 | 跟随角色移动 |
| 紧张时刻 | 晃动镜头 | 增加临场感 |
| 静态思考 | 摇镜头 | 缓慢环视 |

---

## 六、Prompt设计策略

### 6.1 专用Prompt分离

```
【Image Prompt】（用于静态图像生成）
组成要素：
1. 完整的场景背景描述
2. 角色初始静态姿态（去除动作过程）
3. 情绪氛围
4. 风格标签：anime style, first frame

特点：聚焦静态画面，不包含运镜指令

【Video Prompt】（用于视频生成）
组成要素：
1. 人物动作描述
2. 对话内容
3. 镜头运动指令
4. 景别和角度
5. 场景环境
6. 环境氛围
7. 情绪和结果
8. BGM和音效
9. 风格要求：cinematic anime style, smooth camera motion

特点：包含完整动态信息，支持运镜控制
```

### 6.2 分镜Prompt模板

```python
# 图像Prompt生成
def generate_image_prompt(storyboard):
    parts = []
    parts.append(storyboard.location)
    if storyboard.time:
        parts.append(storyboard.time)
    parts.append(extract_initial_pose(storyboard.action))  # 初始姿态
    if storyboard.emotion:
        parts.append(storyboard.emotion)
    parts.append("anime style, first frame")
    return ", ".join(parts)

# 视频Prompt生成
def generate_video_prompt(storyboard):
    parts = []
    parts.append(f"Action: {storyboard.action}")
    if storyboard.dialogue:
        parts.append(f"Dialogue: {storyboard.dialogue}")
    if storyboard.movement:
        parts.append(f"Camera movement: {storyboard.movement}")
    if storyboard.shot_type:
        parts.append(f"Shot type: {storyboard.shot_type}")
    if storyboard.angle:
        parts.append(f"Camera angle: {storyboard.angle}")
    parts.append(f"Scene: {storyboard.location}")
    if storyboard.atmosphere:
        parts.append(f"Atmosphere: {storyboard.atmosphere}")
    parts.append("Style: cinematic anime style, smooth camera motion")
    return ". ".join(parts)
```

---

## 七、异步任务管理

### 7.1 任务状态机

```
                    +---------+
    创建 ----------> | PENDING | <--------- 重试
    |               +---------+
    |                   |
    |                   | 执行
    |                   ↓
    |               +---------+
    |               | RUNNING | <--------- 暂停
    |               +---------+
    |                   |
    |           -------+-------
    |           |           |
    |           ↓           ↓
    |       +-------+   +-------+
    |       | DONE  |   | FAILED |
    |       +-------+   +-------+
    |           |           |
    +-----------+-----------+
        清理/归档     记录错误
```

### 7.2 任务类型

| 任务类型 | 描述 | 预估时长 |
|----------|------|----------|
| ANALYZE_CHAPTERS | 章节分析 | 10-30秒 |
| GENERATE_OUTLINE | 大纲生成 | 30-60秒 |
| GENERATE_SCRIPT | 剧本生成 | 60-120秒 |
| GENERATE_STORYBOARD | 分镜生成 | 60-180秒 |
| GENERATE_IMAGES | 图像生成 | 60-300秒 |
| GENERATE_AUDIO | 音频生成 | 30-120秒 |
| GENERATE_VIDEO | 视频生成 | 120-600秒 |
| MERGE_VIDEO | 视频合成 | 60-180秒 |

### 7.3 错误处理策略

```
【自动重试机制】
- 最大重试次数：3次
- 重试间隔：指数退避（1s, 2s, 4s）
- 临时错误：网络超时、API限流
- 永久错误：参数错误、配额不足（不重试）

【断点续传】
- 每个阶段完成后保存状态
- 中断后可从上次完成阶段继续
- 避免重复生成已完成的素材

【状态持久化】
- SQLite存储任务状态
- 记录进度百分比
- 保存中间结果
```

---

## 八、数据模型设计

### 8.1 核心实体关系

```
Drama（短剧项目）
├── Episodes（剧集）
│   ├── Characters（角色）
│   │   └── CharacterImages（角色图片）
│   ├── Scenes（场景）
│   └── Storyboards（分镜）
│       ├── ImageGenerations（图像生成记录）
│       └── VideoGenerations（视频生成记录）
└── AudioGenerations（音频生成记录）
```

### 8.2 主要数据结构

```python
# 剧集信息
class Episode:
    id: int
    drama_id: int
    episode_num: int
    title: str
    description: str          # 梗概
    script_content: str       # 完整剧本
    duration: int            # 时长（秒）
    status: str              # draft/processing/completed/failed

# 角色信息
class Character:
    id: int
    drama_id: int
    name: str
    role: str                # 主角/配角/反派
    description: str         # 背景简介
    personality: str         # 性格特点
    appearance: str          # 外貌描述（详细）
    voice_style: str         # 说话风格
    reference_image: str     # 参考图路径

# 场景背景
class Scene:
    id: int
    drama_id: int
    location: str             # 地点
    time: str                # 时间
    description: str         # 完整描述
    image_prompt: str         # 图像生成Prompt

# 分镜头
class Storyboard:
    id: int
    episode_id: int
    scene_id: int            # 关联背景
    shot_number: int
    title: str
    shot_type: str           # 景别
    angle: str               # 角度
    time: str                # 时间
    location: str             # 地点
    movement: str             # 运镜
    action: str              # 动作
    dialogue: str            # 对话
    result: str              # 画面结果
    atmosphere: str          # 氛围
    emotion: str             # 情绪
    duration: int            # 时长
    image_prompt: str        # 图像Prompt
    video_prompt: str        # 视频Prompt
    bgm_prompt: str          # BGM提示
    sound_effect: str        # 音效
    characters: list[int]   # 角色ID列表
    is_primary: bool         # 是否主镜
```

---

## 九、素材输出结构

### 9.1 素材包目录结构

```
episode_01_materials/
├── metadata/
│   ├── episode_info.json          # 剧集信息
│   ├── characters.json             # 角色配置
│   └── storyboards.json            # 完整分镜表
│
├── characters/                     # 角色参考图
│   ├── char_001_林凡.jpg
│   ├── char_002_李芳.jpg
│   └── char_003_反派.jpg
│
├── backgrounds/                   # 场景背景图
│   ├── bg_001_废弃仓库.jpg
│   ├── bg_002_豪宅大厅.jpg
│   └── ...
│
├── storyboards/                   # 按镜头顺序
│   ├── scene_001/
│   │   ├── shot_001.jpg           # 首帧图
│   │   ├── shot_001.mp4           # 生成视频
│   │   ├── shot_001_audio.mp3     # 对话音频
│   │   ├── shot_001_bgm.mp3       # BGM
│   │   └── shot_001_sfx.mp3       # 音效
│   ├── scene_002/
│   │   └── ...
│   └── ...
│
├── narrator/                       # 说书人旁白
│   ├── narrator_part_001.mp3
│   ├── narrator_part_002.mp3
│   └── ...
│
├── audio/
│   ├── dialogues.json             # 对话台词
│   ├── character_voices.json      # 角色音色配置
│   └── bgm_library/
│       ├── bgm_tense.mp3
│       ├── bgm_relaxed.mp3
│       ├── bgm_exciting.mp3
│       └── bgm_suspense.mp3
│
├── temp/                          # 临时文件
│   └── ...
│
└── README.txt                      # 使用说明
```

### 9.2 元数据文件示例

```json
// episode_info.json
{
  "episode_number": 1,
  "title": "第一章：废物赘婿的逆袭",
  "source_chapters": [1, 2],
  "total_duration": 240,
  "shot_count": 20,
  "hook_type": "身份揭秘",
  "cliffhanger_type": "幕后黑手"
}

// storyboards.json（完整分镜表）
{
  "storyboards": [
    {
      "shot_number": 1,
      "title": "噩梦惊醒",
      "shot_type": "全景",
      "angle": "俯视45度角",
      "time": "深夜22:30·月光从破窗斜射入仓库",
      "location": "废弃码头仓库",
      "movement": "固定镜头",
      "action": "陈峥弯腰用撬棍撬动保险箱门",
      "dialogue": "（独白）这么多年了，里面到底藏着什么？",
      "result": "保险箱门突然弹开，箱内空无一物",
      "atmosphere": "昏暗冷色调",
      "emotion": "好奇感↑↑转失望↓",
      "duration": 9,
      "bgm_prompt": "低沉紧张的弦乐",
      "sound_effect": "金属碰撞声、灰尘飘散声",
      "characters": [1],
      "is_primary": true
    }
  ],
  "total_duration": 180
}
```

---

## 十、质量控制标准

### 10.1 剧情还原度检查

```
【100%还原原则】
- 从剧本第一个字到最后一个字，逐句逐段转换为分镜
- 每个对话、每个动作、每个场景转换都必须有对应的分镜
- 剧本越长，分镜数量越多
-宁可分镜多，也不要遗漏剧情

【禁止行为】
- 禁止用一个镜头概括多个场景
- 禁止跳过任何对话或独白
- 禁止省略剧情发展过程
- 禁止合并本应分开的镜头
```

### 10.2 质量评分维度

| 维度 | 权重 | 检查项 |
|------|------|--------|
| 剧情还原度 | 30% | 是否100%覆盖剧本内容 |
| 节奏合理性 | 25% | 时长分配是否合理 |
| 情绪连贯性 | 20% | 情绪变化是否自然 |
| 视觉描述 | 15% | Prompt是否足够详细 |
| 规范符合度 | 10% | 是否符合短剧规范 |

### 10.3 质量评分标准

```
【A级（优秀）】90-100分
- 剧情100%还原，无遗漏
- 节奏把控精准，爽点密集
- 情绪连贯，感染力强
- Prompt详尽，AI生成质量高

【B级（良好）】75-89分
- 剧情基本还原，个别细节遗漏
- 节奏合理，偶有拖沓
- 情绪较为连贯
- Prompt较完整

【C级（合格）】60-74分
- 剧情大部分还原，有明显遗漏
- 节奏有偏差，需要调整
- 情绪有断层
- Prompt需补充

【D级（不合格）】<60分
- 剧情严重遗漏
- 节奏混乱
- 情绪断裂
- Prompt不完整
```

---

## 十一、用户交互设计

### 11.1 交互模式

```
【全自动模式】
python cli.py novel.txt --auto
- 全程无需干预
- 适合熟悉流程的用户

【交互式模式】
python cli.py novel.txt --interactive
- 每阶段完成后暂停，等待用户确认
- 可调整参数后继续

【分步模式】
python cli.py novel.txt --plan-only        # 仅规划
python cli.py novel.txt --episode 1        # 仅生成第1集
python cli.py novel.txt --episode 1 --step storyboard  # 仅分镜
```

### 11.2 交互流程示例

```
=== 灵影短剧生成系统 ===

[1/7] 读取小说
  已读取：novel.txt
  识别章节：15章

[2/7] 章节分析
  分析完成，平均密度：72分
  建议分集：5集

[3/7] 分集规划（待确认）
  第1集：第1-3章 | 密度68 | 预计18镜 | 4分钟
  第2集：第4-6章 | 密度75 | 预计22镜 | 5分钟
  ...
  [A]接受建议 [M]手动调整 [S]跳过

  > a

[4/7] 生成大纲
  ✓ 梗概生成完成（452字）
  ✓ 角色提取完成（5个角色）
  ✓ 卡点识别完成（12个爽点）

[5/7] 剧本生成（待确认）
  第1集剧本预览：
  ----------------------------------------
  镜头1：豪宅大厅（8秒）
  情绪：紧张→爽

  [P]预览完整剧本 [G]重新生成 [C]继续

  > p

  [完整剧本预览...]

  > c

[6/7] 分镜生成
  ✓ 生成分镜表（18个镜头）
  ✓ 生成Image Prompt
  ✓ 生成Video Prompt

[7/7] 素材生成
  角色图：[██████████] 10/10
  场景图：[████████░░] 8/10
  音频 ：[██████░░░░] 6/10
  视频 ：[████░░░░░░] 5/10
  ...
  完成！

输出目录：./output/episode_01_materials/
```

---

## 十二、开发里程碑

### 第一阶段：基础架构（预计3天）
- [ ] 项目结构搭建
- [ ] 数据模型定义
- [ ] 异步任务系统
- [ ] 章节分析模块
- [ ] 分集规划模块

### 第二阶段：内容生成（预计4天）
- [ ] 梗概生成器
- [ ] 角色提取器
- [ ] 剧本生成器
- [ ] 分镜生成器
- [ ] Prompt分离器

### 第三阶段：素材生成（预计4天）
- [ ] 角色图像生成器
- [ ] 场景图像生成器
- [ ] 音频生成器
- [ ] 视频生成器
- [ ] 素材整理器

### 第四阶段：集成测试（预计2天）
- [ ] 端到端工作流
- [ ] CLI接口
- [ ] 错误处理
- [ ] 质量评分
- [ ] 性能优化

### 第五阶段：优化完善（预计2天）
- [ ] 用户体验优化
- [ ] 文档完善
- [ ] 边界情况处理
- [ ] 压力测试

**总计：预计15天完成第一版**

---

## 十三、后续优化方向

### 第二版功能
1. [ ] 自动字幕生成（集成ASR）
2. [ ] 自动视频拼接（集成FFmpeg）
3. [ ] 多风格模板系统
4. [ ] 实时预览功能
5. [ ] 用户偏好学习

### 第三版功能
1. [ ] Web管理界面
2. [ ] 团队协作
3. [ ] 模板市场
4. [ ] API开放平台
5. [ ] 批量生成

---

## 文档更新记录

| 日期 | 更新内容 | 更新人 |
|------|----------|--------|
| 2026-02-06 | 整合Huobao Drama设计，优化工作流程 | 系统 |
| 2026-02-04 | 初始版本 | 系统 |
